<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gerar Relatório</title>
<link rel="stylesheet" href="style.css" />
<script src="menu.js" defer></script>
<style>
  pre {
    background: #f8cbd0;
    padding: 15px;
    border-radius: 8px;
    max-height: 300px;
    overflow-y: auto;
    text-align: left;
    font-size: 0.9rem;
  }
</style>
</head>
<body>
  <div class="container">
    <h1>Gerar Relatório</h1>
    <form id="formRelatorio">
      <label for="dataInicio">Data Início:</label>
      <input type="date" id="dataInicio" required />
      <label for="dataFim">Data Fim:</label>
      <input type="date" id="dataFim" required />
      <button type="submit">Gerar Relatório</button>
    </form>
    <pre id="resultado" style="display:none;"></pre>
  </div>

  <script>
    function formatDateBR(isoStr) {
      if (!isoStr) return '';
      const d = new Date(isoStr);
      return d.toLocaleDateString('pt-BR');
    }

    function filtrarPorData(lista, dataInicio, dataFim) {
      return lista.filter(item => {
        const dataItem = new Date(item.dataCadastro || item.dataDemissao || item.dataInicio || item.dataFim);
        return dataItem >= dataInicio && dataItem <= dataFim;
      });
    }

    function montarRelatorio(listaAtivos, listaInativos, listaFerias, listaAviso, dataInicio, dataFim) {
      let rel = 'Relatório RH Evoluído\n\n';

      rel += 'Funcionários Ativos:\n';
      const ativosFiltrados = listaAtivos.filter(f => {
        const data = new Date(f.dataCadastro);
        return data >= dataInicio && data <= dataFim;
      });
      ativosFiltrados.forEach(f => {
        rel += `- ${f.nome} | CPF: ${f.cpf} | Local: ${f.local} | Data Cadastro: ${formatDateBR(f.dataCadastro)}\n`;
      });
      rel += '\n';

      rel += 'Funcionários Inativos:\n';
      const inativosFiltrados = listaInativos.filter(f => {
        const data = new Date(f.dataDemissao);
        return data >= dataInicio && data <= dataFim;
      });
      inativosFiltrados.forEach(f => {
        rel += `- ${f.nome} | CPF: ${f.cpf} | Data Demissão: ${formatDateBR(f.dataDemissao)} | Motivo: ${f.motivo} | Local: ${f.local}\n`;
      });
      rel += '\n';

      rel += 'Férias Registradas:\n';
      const feriasFiltradas = listaFerias.filter(f => {
        const inicio = new Date(f.dataInicio);
        const fim = new Date(f.dataFim);
        // Verifica se período de férias intersecta com intervalo
        return (inicio <= dataFim && fim >= dataInicio);
      });
      feriasFiltradas.forEach(f => {
        rel += `- ${f.nome} | CPF: ${f.cpf} | Início: ${formatDateBR(f.dataInicio)} | Fim: ${formatDateBR(f.dataFim)}\n`;
      });
      rel += '\n';

      rel += 'Aviso Prévio:\n';
      const avisoFiltrados = listaAviso.filter(f => {
        const data = new Date(f.dataInicio);
        return data >= dataInicio && data <= dataFim;
      });
      avisoFiltrados.forEach(f => {
        rel += `- ${f.nome} | CPF: ${f.cpf} | Data Início: ${formatDateBR(f.dataInicio)} | Data Fim: ${formatDateBR(f.dataFim)} | Local: ${f.local}\n`;
      });

      return rel;
    }

    document.getElementById('formRelatorio').addEventListener('submit', e => {
      e.preventDefault();
      const dataInicio = new Date(document.getElementById('dataInicio').value);
      const dataFim = new Date(document.getElementById('dataFim').value);

      if (!dataInicio || !dataFim || dataInicio > dataFim) {
        alert('Informe um intervalo de datas válido!');
        return;
      }

      const listaAtivos = JSON.parse(localStorage.getItem('funcionariosAtivos')) || [];
      const listaInativos = JSON.parse(localStorage.getItem('funcionariosInativos')) || [];
      const listaFerias = JSON.parse(localStorage.getItem('ferias')) || [];
      const listaAviso = JSON.parse(localStorage.getItem('avisoPrevio')) || [];

      const relatorio = montarRelatorio(listaAtivos, listaInativos, listaFerias, listaAviso, dataInicio, dataFim);
      const resultado = document.getElementById('resultado');
      resultado.textContent = relatorio;
      resultado.style.display = 'block';
    });
  </script>
</body>
</html>
